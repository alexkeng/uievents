<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Keyboard Event Viewer</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<script type="text/javascript" src="output-table.js" ></script>
<script type="text/javascript" src="options.js" ></script>
<script type="text/javascript" src="key-event-viewer-edit-context.js" ></script>
<link rel="stylesheet" type="text/css" href="key-event-viewer.css" />
</head>

<body>
<a class="main_link" href="main.html">UI Events Testing Tools</a>
<h1>Keyboard Event Viewer <span class="subtitle">for EditContext</span></h1>
<p>UserAgent: <span id="useragent"></span></p>
<p><code>div</code> with <code>contenteditable="false"</code> with EditContext attached:</p>
<p><input id="resetTable" type="button" onclick="resetTable();return false" value="Clear Table"/> <a id="optionsToggle" href="javascript:toggleOptions()">Show Options</a></p>
<div id="options"></div>

<div id="editableView" contenteditable=false style="position: relative; padding:3px;white-space:pre-wrap; width:300px; height:150px; border:blue 1px dashed" tabindex="-1"></div>

<br><table id="output"></table>

<script language="javascript">
init();
</script>

<script>
    var editContext = new EditContext();

    var viewElement = document.getElementById("editableView");
    viewElement.attachEditContext(editContext);

    viewElement.addEventListener("focus", e => {
        editContext.focus();
    });

    viewElement.addEventListener("blur", e => {
        editContext.blur();
    });

    viewElement.addEventListener("beforeinput", e => {
        if (e.inputType === "deleteContentBackward") {
            //e.preventDefault();
        }
    });

    editContext.addEventListener("textupdate", e => {
        console.log(`textupdate:[${e.updateText}], range (${e.updateRangeStart}, ${e.updateRangeEnd}), selection (${e.newSelectionStart}, ${e.newSelectionEnd})`)
        // Update event table
        handleKeyEvent("keydown", e);

        // Visualize EditContext buffer
        viewElement.innerHTML = editContext.text;

        // Visualize caret/selection
        let textNode = viewElement.childNodes[0];
        let selection_range = document.createRange();
        selection_range.setStart(textNode, e.newSelectionStart);
        selection_range.setEnd(textNode, e.newSelectionEnd);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(selection_range);

        // Update bounds for IME. (TODO: handle zoom factor)
        let controlBound = viewElement.getBoundingClientRect();
        let selectionBound = selection_range.getBoundingClientRect();
        editContext.updateLayout(controlBound, selectionBound);

        // Show dashed line if the composition is in progress.
        if (e.updateRangeStart != e.updateRangeEnd) {
            showDashedLine(textNode, e);
        }
    });

    editContext.addEventListener("textformatupdate", e => { 
        handleKeyEvent("keydown", e);
    });

    editContext.addEventListener("compositionstart", e => { 
        handleKeyEvent("keydown", e);
    });

    editContext.addEventListener("compositionend", e => { 
        handleKeyEvent("keydown", e);
        hideDashedLine();
    });

    function showDashedLine(textNode, e) {
        let range = document.createRange();
        range.setStart(textNode, e.updateRangeStart);
        range.setEnd(textNode, e.updateRangeEnd);
        let compositionBound = range.getBoundingClientRect();
        let controlBound = viewElement.getBoundingClientRect();
        let dashlineSpacing = 3;
        let bottomOffset = controlBound.bottom - compositionBound.bottom - dashlineSpacing;
        let leftOffset = compositionBound.left - controlBound.left;

        let dashedLine = document.createElement("div");
        dashedLine.style = "position:absolute; bottom:5px; border-bottom:1px dashed gray";
        dashedLine.style.width = compositionBound.width + "px";
        dashedLine.style.bottom = bottomOffset + "px";
        dashedLine.style.left = leftOffset + "px";
        viewElement.appendChild(dashedLine);
    }

    function hideDashedLine() {
        viewElement.removeChild(viewElement.lastChild); // assume the last child is the <div> for the dashed line.
    }
</script>
</body>
</html>
