<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Keyboard Event Viewer</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<script type="text/javascript" src="output-table.js" ></script>
<script type="text/javascript" src="options.js" ></script>
<script type="text/javascript" src="key-event-viewer-edit-context.js" ></script>
<link rel="stylesheet" type="text/css" href="key-event-viewer.css" />
<style>
    .blink {
      animation: blink-animation 1s steps(5, start) infinite;
    }
    @keyframes blink-animation {
      to {  visibility: hidden; }
    }
</style>
</head>

<body>
<a class="main_link" href="main.html">UI Events Testing Tools</a>
<h1>Keyboard Event Viewer <span class="subtitle">for EditContext</span></h1>
<p>UserAgent: <span id="useragent"></span></p>
<p><code>div</code> with <code>contenteditable="false"</code> with EditContext attached:</p>
<p><input id="resetTable" type="button" onclick="resetTable();return false" value="Clear Table"/> <a id="optionsToggle" href="javascript:toggleOptions()">Show Options</a></p>
<div id="options"></div>

<table><tr>
    <td>
        <div id="editableView" contenteditable=false style="color: transparent;text-shadow: 0 0 0 black;position: relative; padding:3px;white-space:pre-wrap; width:300px; height:150px; border:blue 1px dashed" tabindex="-1"></div>
    </td>
    <td>
        <div id="editableView2" contenteditable=false style="color: transparent;text-shadow: 0 0 0 black;position: relative; padding:3px;white-space:pre-wrap; width:300px; height:150px; border:blue 1px dashed" tabindex="-1"></div>
    </td>
    <td>
        <div id="editableView3" contenteditable=false style="color: transparent;text-shadow: 0 0 0 black;position: relative; padding:3px;white-space:pre-wrap; width:300px; height:150px; border:blue 1px dashed" tabindex="-1"></div>
    </td>
</tr></table>

<br><table id="output"></table>

<script language="javascript">
init();
</script>

<script>
    var editContext = new EditContext();

    var viewElement = document.getElementById("editableView");
    var viewElement2 = document.getElementById("editableView2");
    var viewElement3 = document.getElementById("editableView3");

    viewElement.attachEditContext(editContext);
    viewElement3.attachEditContext(editContext);

    viewElement.addEventListener("focus", e => {
        editContext.focus();
        updateView(viewElement, "", 0, 0, true);
        updateView(viewElement2, "", 0, 0, false);
        updateView(viewElement3, "", 0, 0, false);
    });

    viewElement.addEventListener("blur", e => {
        editContext.blur();
    });

    viewElement.addEventListener("beforeinput", e => {
        if (e.inputType === "deleteContentBackward") {
            //e.preventDefault();
        }
    });

    editContext.addEventListener("textupdate", e => {
        console.log(`textupdate:[${e.updateText}], composition range (${e.updateRangeStart}, ${e.updateRangeEnd}), selection (${e.newSelectionStart}, ${e.newSelectionEnd})`)
        // Update event table
        handleKeyEvent("keydown", e);

        if (e.updateRangeStart != e.updateRangeEnd) {
            // Show dashed line if composition is in progress.
            updateViewWithComposition(viewElement, editContext.text, e.newSelectionStart, e.newSelectionEnd, e.updateRangeStart, e.updateRangeEnd, true);
            updateViewWithComposition(viewElement2, editContext.text, e.newSelectionStart, e.newSelectionEnd, e.updateRangeStart, e.updateRangeEnd, false);
            updateViewWithComposition(viewElement3, editContext.text, e.newSelectionStart, e.newSelectionEnd, e.updateRangeStart, e.updateRangeEnd, false);
        } else {
            // Hide dashed line.
            updateView(viewElement, editContext.text, e.newSelectionStart, e.newSelectionEnd, true);
            updateView(viewElement2, editContext.text, e.newSelectionStart, e.newSelectionEnd, false);
            updateView(viewElement3, editContext.text, e.newSelectionStart, e.newSelectionEnd, false);
        }
    });

    editContext.addEventListener("textformatupdate", e => { 
        handleKeyEvent("keydown", e);
    });

    editContext.addEventListener("compositionstart", e => { 
        handleKeyEvent("keydown", e);
    });

    editContext.addEventListener("compositionend", e => { 
        handleKeyEvent("keydown", e);
        updateView(viewElement, editContext.text, editContext.selectionStart, editContext.selectionEnd, true);
        updateView(viewElement2, editContext.text, editContext.selectionStart, editContext.selectionEnd, false);
        updateView(viewElement3, editContext.text, editContext.selectionStart, editContext.selectionEnd, false);
    });

    function updateView(viewElement, text, selectionStart, selectionEnd, updateSelectionBound) {
        viewElement.innerHTML = text;

        if (text == "") {
            let caret = document.createElement("span");
            caret.style = "width:1px; border-left:1px solid black";
            caret.classList.add('blink');
            viewElement.appendChild(caret);
        } else {
            updateSelection(viewElement, viewElement.childNodes[0], selectionStart, selectionEnd, updateSelectionBound);
        }
    }

    function updateViewWithComposition(viewElement, text, selectionStart, selectionEnd, compositionStart, compositionEnd, updateSelectionBound) {
        viewElement.innerHTML = text;
        let textNode = viewElement.childNodes[0];
        textNode.splitText(compositionEnd); // trim text after composition
        let compositionTextNode = textNode.splitText(compositionStart);

        let dashedLine = document.createElement("span");
        dashedLine.style = "border-bottom:1px dashed gray";
        viewElement.insertBefore(dashedLine, compositionTextNode);
        dashedLine.appendChild(compositionTextNode);

        updateSelection(viewElement, compositionTextNode, selectionStart - compositionStart, selectionEnd - compositionStart, updateSelectionBound);
    }

    function updateSelection(viewElement, textNode, selectionStart, selectionEnd, updateSelectionBound) {
        if (selectionStart == selectionEnd) {
            // add custom caret
            let TextNodeAfterCaret = textNode.splitText(selectionStart);
            let caret = document.createElement("span");
            caret.style = "width:1px; border-left:1px solid black";
            caret.classList.add('blink');
            TextNodeAfterCaret.parentElement.insertBefore(caret, TextNodeAfterCaret);

            // Update bounds for IME. (TODO: handle zoom factor)
            if (updateSelectionBound) {
                let controlBound = viewElement.getBoundingClientRect();
                let selectionBound = caret.getBoundingClientRect();
                editContext.updateLayout(controlBound, selectionBound);
            }
        } else {
            textNode.splitText(selectionEnd); // trim text after composition
            let SelectedTextNode = textNode.splitText(selectionStart);

            let dashedLine = document.createElement("span");
            dashedLine.style = "color:white; background-color:#3390ff";
            viewElement.insertBefore(dashedLine, SelectedTextNode);
            dashedLine.appendChild(SelectedTextNode);
        }
    }
</script>
</body>
</html>
